rm(list = ls())
setwd("...")
getwd()
devtools::install_github("sqjin/CellChat")
Sys.setenv(RETICULATE_PYTHON="C:/Users/2022/AppData/Local/Microsoft/WindowsApps/python3.exe")
library(Seurat)
library(SeuratData)
library(tidyverse)
library(CellChat)
library(NMF)
library(ggalluvial)
library(patchwork)
library(ggplot2)
library(svglite)
options(stringsAsFactors = FALSE)
library(BiocNeighbors)

scRNA_harmony<-readRDS("...")
Idents(scRNA_harmony)=scRNA_harmony$Recluster1.0
cellchat <-createCellChat(scRNA_harmony@assays$RNA@data, meta = scRNA_harmony@meta.data, 
                          group.by ="Recluster1.0")
summary(cellchat)
str(cellchat)
levels(cellchat@idents)
groupSize <- as.numeric(table(cellchat@idents))
groupSize


CellChatDB <- CellChatDB.human 
showDatabaseCategory(CellChatDB)
unique(CellChatDB$interaction$annotation)
CellChatDB.use <- subsetDB(CellChatDB,search = "Secreted Signaling")
#set the used database in the object
cellchat@DB <-CellChatDB.use

cellchat <- subsetData(cellchat,features = NULL)
cellchat <- identifyOverExpressedGenes(cellchat)
cellchat <- identifyOverExpressedInteractions(cellchat)
cellchat <- projectData(cellchat, PPI.human)
cellchat <- computeCommunProb(cellchat)
cellchat <- computeCommunProbPathway(cellchat)
cellchat <- aggregateNet(cellchat)
#cellchat <- netAnalysis_signalingRole_network(cellchat, slot.name = "netP")
#netAnalysis_contribution(cellchat, signaling = pathways.show)
# Compute and visualize the contribution of each ligand-receptor pair to the overall signaling pathway


cellchat<-aggregateNet(cellchat)
goupSize <- as.numeric(table(cellchat@idents))
par(mfrow=c(1,2),xpd=TRUE)
netVisual_circle(cellchat@net$count,vertex.weight = groupSize, weight.scale = T,
                 label.edge = F, title.name = "Number of interactions"  )
netVisual_circle(cellchat@net$weight,vertex.weight = groupSize, weight.scale = T,
                 label.edge = F, title.name = "Interaction weights/strength"  )

mat<-cellchat@net$weight
par(mfrow=c(3,3), xpd=TRUE)
for (i in 1:nrow(mat)) {
  mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
  mat2[i,] <-mat[i,]
  netVisual_circle(mat2, vertex.weight = groupSize, weight.scale = T , arrow.width = 0.2,
                   arrow.size = 0.1, edge.weight.max = max(mat), title.name = rownames(mat)[i] )}

levels(cellchat@idents)
p = netVisual_bubble(cellchat , sources.use = c(1,5,6,7,8), targets.use = c(2,3,4),
                     remove.isolate = FALSE)
p2 = netVisual_bubble(cellchat , sources.use = c(1,2) , targets.use =c(7,9),
                      remove.isolate = FALSE)
p3 = netVisual_bubble(cellchat , sources.use = c(7,9) , targets.use =c(1,2),
                      remove.isolate = FALSE)
p2+p3

pathways.show<-c("CXCL")
netVisual_heatmap(cellchat, signaling = pathways.show,color.heatmap = "Reds")

netAnalysis_contribution(cellchat,signaling = pathways.show)

cellchat<-netAnalysis_computeCentrality(cellchat,slot.name = "netP")
netAnalysis_signalingRole_network(cellchat,signaling = pathways.show)

ht1<-netAnalysis_signalingRole_heatmap(cellchat, pattern = "outgoing",font.size = 5)
ht2<-netAnalysis_signalingRole_heatmap(cellchat, pattern = "incoming",font.size = 5)
ht1+ht2























































































































































































































































